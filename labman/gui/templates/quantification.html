{% extends sitebase.html %}

{% block head %}
{% import json %}

<script src="/static/vendor/js/plotly-1.33.1.min.js"></script>


<script type='text/javascript'>
  function confirmQuantification() {
    var plates = {% raw json.dumps(plates) %};
    $.post("/process/quantify", {'plates-info': JSON.stringify(plates)}, function(data) {
      bootstrapAlert('Information saved', 'success');
      disableAll();
    })
      .fail(function (jqXHR, textStatus, errorThrown) {
        bootstrapAlert(jqXHR.responseText, 'danger');
      });
  };

  function cancelQuantification() {
    if (confirm('Are you sure you want to cancel the current quantification?')) {
      window.location.href = "/process/parse_quantify";
    }
  };

  /**
   * Determine an appropriate clipping value for the heatmap's maximum value.
   *
   * @param {Float} plateType String describing the plate type.
   * @returns A maximum expected value for the colorscale of a heatmap.
   *
   */
  function clippingForPlateType(plateType) {
    if (plateType == '16S library prep') {
      return 100;
    }
    else if (plateType == 'shotgun library prep') {
      return 30;
    }
    else if (plateType == 'gDNA' || plateType == 'compressed gDNA') {
      return 20;
    }

    // should never get here but if it does, then the range is permissive
    return 10000;
  }

  $(document).ready(function(){
    var plates = {% raw json.dumps(plates) %};

    for (var plateInfo of plates) {
      var defaultClipping = clippingForPlateType(plateInfo.type);
      var concentrations = plateInfo.concentrations;
      var names = plateInfo.names;
      var blanks = plateInfo.blanks;

      createHeatmap(plateInfo.plate_id, concentrations, blanks, names,
                    defaultClipping, 'Viridis');
    }
  });
</script>

{% end %}

{% block content %}
<label><h3>Review plate quantification values</h3></label> <button class="btn btn-success" onclick="confirmQuantification();">Confirm</button> <button class="btn btn-danger" onclick="cancelQuantification();">Cancel</button>

{% for plate_info in plates %}
<div list-group-item>
  <h4>{{plate_info['plate_name']}}</h4>
  <div id='pool-results-{{plate_info['plate_id']}}'></div>
<div>
{% end %}

{% end %}
